name: Email Daily Commit Report

on:
  workflow_dispatch:  # Manual trigger for now

jobs:
  email-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout collector repository
        uses: actions/checkout@v4

      - name: Combine commit message files
        id: generate
        run: |
          echo "Collecting commit message files..."
          mkdir -p reports

          # Find latest directory that matches pattern
          LATEST_DIR=$(ls -td commit-messages-Date* 2>/dev/null | head -n 1)

          if [ -z "$LATEST_DIR" ]; then
            echo "âŒ No commit message directory found."
            REPORT_FILE="reports/empty_report_$(date +'%Y-%m-%d_%H-%M').txt"
            echo "No commit messages found to include." > "$REPORT_FILE"
          else
            REPORT_FILE="reports/combined_commits_${LATEST_DIR}_$(date +'%Y-%m-%d_%H-%M').txt"

            echo "ðŸ§¾ Combined Commit Report" > "$REPORT_FILE"
            echo "Directory: $LATEST_DIR" >> "$REPORT_FILE"
            echo "Generated at: $(date)" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"

            FILES_FOUND=false
            for file in "$LATEST_DIR"/*.txt; do
              if [ -f "$file" ]; then
                FILES_FOUND=true
                echo "===============================" >> "$REPORT_FILE"
                echo "ðŸ“¦ Repo File: $(basename "$file")" >> "$REPORT_FILE"
                echo "-------------------------------" >> "$REPORT_FILE"
                cat "$file" >> "$REPORT_FILE"
                echo "" >> "$REPORT_FILE"
              fi
            done

            if [ "$FILES_FOUND" = false ]; then
              echo "âš ï¸ No .txt commit files found inside $LATEST_DIR." >> "$REPORT_FILE"
            fi
          fi

          echo "REPORT_FILE=$REPORT_FILE" >> $GITHUB_ENV  # âœ… set as env var for next step

      - name: Send Combined Report by Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "ðŸ§¾ Daily Combined Commit Report"
          body: |
            Hi Team,

            Please find attached the **daily combined commit report**
            summarizing all commits collected from the latest autopromotions.

            â€” GitHub Autopromotion Bot ðŸ¤–
          to: "ruthvick.ravu@gmail.com"
          from: "GitHub Commit Reporter <ruthvicktest@gmail.com>"
          attachments: ${{ env.REPORT_FILE }}
