name: Email Combined Commit Report

on:
  schedule:
    # Runs daily at 7:10 AM Central (12:10 UTC)
    - cron: '10 12 * * *'
  workflow_dispatch:

jobs:
  email-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout collector repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ruthvick-rr/collector-repo-
          token: ${{ secrets.AUTOPROMOTION_PAT }}

      - name: Combine commit message files (today's date folder)
        id: generate
        shell: bash
        run: |
          # Get today's date in Central Time (CDT)
          TODAY=$(TZ=America/Chicago date +'%Y-%m-%d')
          TARGET_DIR="commit-messages-${TODAY}"

          echo "ðŸ“… Target folder for today: $TARGET_DIR"

          if [ ! -d "$TARGET_DIR" ]; then
            echo "âš ï¸ Folder $TARGET_DIR not found â€” using yesterday as fallback."
            YESTERDAY=$(TZ=America/Chicago date -d "yesterday" +'%Y-%m-%d')
            TARGET_DIR="commit-messages-${YESTERDAY}"
          fi

          if [ ! -d "$TARGET_DIR" ]; then
            echo "âŒ No commit message directories found for today or yesterday."
            exit 0
          fi

          echo "ðŸ“‚ Using directory: $TARGET_DIR"

          mkdir -p reports
          REPORT_FILE="reports/combined_commits_${TODAY}.txt"

          echo "ðŸ§¾ Daily Combined Commit Report" > "$REPORT_FILE"
          echo "Generated at: $(date)" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          FILES_FOUND=false

          for file in "$TARGET_DIR"/*.txt; do
            if [ -f "$file" ]; then
              FILES_FOUND=true
              echo "===============================" >> "$REPORT_FILE"
              echo "ðŸ“¦ Repository: $(basename "$file")" >> "$REPORT_FILE"
              echo "-------------------------------" >> "$REPORT_FILE"
              cat "$file" >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"
            fi
          done

          if [ "$FILES_FOUND" = false ]; then
            echo "âš ï¸ No .txt commit message files found in $TARGET_DIR." >> "$REPORT_FILE"
          fi

          echo "âœ… Combined report created: $REPORT_FILE"
          echo "REPORT_FILE=$REPORT_FILE" >> $GITHUB_OUTPUT

      - name: Send Email with Combined Report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "ðŸ§¾ Daily Combined Commit Report (Yesterday 7 AM â†’ Today 7 AM)"
          body: |
            Hi Team,

            Please find attached the **daily combined commit report**
            containing all commits from yesterday 7 AM to today 7 AM (Central Time).

            â€” GitHub Autopromotion Bot ðŸ¤–
          to: "ruthvick.ravu@gmail.com"
          from: "GitHub Commit Reporter <ruthvicktest@gmail.com>"
          attachments: ${{ steps.generate.outputs.REPORT_FILE }}
